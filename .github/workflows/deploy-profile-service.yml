name: Deploy Profile Service to Production

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'lianel/dc/profile-service/**'
      - 'lianel/dc/docker-compose.backend.yaml'
      - 'lianel/dc/docker-compose.yaml'
      - '.github/workflows/deploy-profile-service.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io

jobs:
  build-and-deploy:
    name: Build and Deploy Profile Service
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set lowercase image name
        id: image-name
        run: |
          # Lowercase the repository name immediately to fix case sensitivity issues
          IMAGE_NAME_LC=$(echo "${{ github.repository }}/lianel-profile-service" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME_LC=${IMAGE_NAME_LC}" >> $GITHUB_ENV
          echo "image_name=${IMAGE_NAME_LC}" >> $GITHUB_OUTPUT
          echo "âœ… Image name set to: ${IMAGE_NAME_LC}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.image-name.outputs.image_name }}
          tags: |
            # Only keep latest tag to save storage (removed branch and sha tags)
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./lianel/dc/profile-service
          file: ./lianel/dc/profile-service/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Make package public automatically
        if: success()
        run: |
          PACKAGE_NAME="${{ steps.image-name.outputs.image_name }}"
          echo "Making package public: $PACKAGE_NAME"
          
          # Use GitHub API to make package public
          gh api \
            -X PATCH \
            "/user/packages/container/${PACKAGE_NAME}" \
            -f visibility=public \
            || echo "âš ï¸  Note: Package might already be public or API call failed (this is OK)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # REMOVED: Artifact upload to save storage (image is already in registry)
      # Image will be pulled directly from registry on remote host

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.REMOTE_HOST }}" ]; then
            echo "âŒ Error: REMOTE_HOST secret is not set"
            echo "Please add REMOTE_HOST secret in repository settings"
            exit 1
          fi
          if [ -z "${{ secrets.REMOTE_USER }}" ]; then
            echo "âŒ Error: REMOTE_USER secret is not set"
            echo "Please add REMOTE_USER secret in repository settings"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ Error: SSH_PRIVATE_KEY secret is not set"
            echo "Please add SSH_PRIVATE_KEY secret in repository settings"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Setup SSH Key
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write SSH key properly (handle multiline)
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Verify key file exists and has content
          if [ ! -s ~/.ssh/deploy_key ]; then
            echo "âŒ Error: SSH key file is empty or missing"
            exit 1
          fi
          
          # Verify key format (should start with -----BEGIN)
          if ! head -1 ~/.ssh/deploy_key | grep -q "BEGIN"; then
            echo "âš ï¸  Warning: SSH key might not be in correct format"
            echo "First line: $(head -1 ~/.ssh/deploy_key)"
          fi
          
          if [ -n "$REMOTE_HOST" ]; then
            ssh-keyscan -H "$REMOTE_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
          fi
          echo "âœ… SSH key setup complete"
          echo "Key file size: $(wc -c < ~/.ssh/deploy_key) bytes"

      - name: Test SSH Connection
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} "echo 'âœ… SSH connection successful'"

      - name: Deploy to Remote Host
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IMAGE_TAG_FULL="${{ env.REGISTRY }}/${{ steps.image-name.outputs.image_name }}:latest"
          echo "ðŸ” Debug: Constructed image tag: $IMAGE_TAG_FULL"
          echo "ðŸ” Debug: Registry: ${{ env.REGISTRY }}"
          echo "ðŸ” Debug: Image name: ${{ steps.image-name.outputs.image_name }}"
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} bash -s << EOF
            set -euxo pipefail
            IMAGE_TAG_FULL="${IMAGE_TAG_FULL}"
            echo "ðŸ” Debug: Received image tag on remote: $IMAGE_TAG_FULL"
            GITHUB_TOKEN="${GITHUB_TOKEN}"
            echo "=== Deploying profile service from registry ==="
            cd /root/lianel/dc
            
            # Pull image directly from registry
            # If package is private, login first (optional - only if GITHUB_PAT secret exists)
            echo "ðŸ“¥ Pulling image from registry..."
            IMAGE_TAG="${IMAGE_TAG_FULL}"
            
            # Debug: Show image tag details
            echo "Image tag to pull: $IMAGE_TAG"
            echo "Image tag length: ${#IMAGE_TAG}"
            echo "Image tag components:"
            echo "  - Full: $IMAGE_TAG"
            echo "  - Registry: $(echo $IMAGE_TAG | cut -d'/' -f1)"
            echo "  - Path: $(echo $IMAGE_TAG | cut -d'/' -f2-)"
            
            # Basic validation (check for required components)
            if [[ -z "$IMAGE_TAG" ]] || [[ ! "$IMAGE_TAG" =~ : ]]; then
              echo "âŒ Error: Invalid image tag format: $IMAGE_TAG"
              echo "Expected format: registry/owner/repo/image:tag"
              exit 1
            fi
            
            # Try to pull (works if package is public)
            echo "Attempting to pull: $IMAGE_TAG"
            if docker pull "$IMAGE_TAG" 2>&1; then
              echo "âœ… Image pulled successfully"
              docker images | grep "$(echo $IMAGE_TAG | cut -d: -f1)" || true
            else
              PULL_EXIT_CODE=$?
              echo "âš ï¸  Pull failed (exit code: $PULL_EXIT_CODE), package is private - authenticating..."
              # Use GITHUB_TOKEN for authentication (automatically available in workflows)
              if [ -n "$GITHUB_TOKEN" ]; then
                echo "Using GITHUB_TOKEN for authentication..."
                echo "Logging in as: ${{ github.actor }}"
                echo "$GITHUB_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin 2>&1
                LOGIN_EXIT=$?
                if [ $LOGIN_EXIT -ne 0 ]; then
                  echo "âš ï¸  Warning: Docker login failed (exit code: $LOGIN_EXIT)"
                  echo "This might be a permissions issue. Check workflow permissions include 'packages: read'"
                else
                  echo "âœ… Docker login successful"
                fi
                if docker pull "$IMAGE_TAG" 2>&1; then
                  echo "âœ… Image pulled successfully with authentication"
                  docker images | grep "$(echo $IMAGE_TAG | cut -d: -f1)" || true
                else
                  echo "âŒ Error: Failed to pull image even with authentication"
                  echo "Image: $IMAGE_TAG"
                  echo "ðŸ’¡ Make package public: Settings â†’ Packages â†’ Package name â†’ Package settings â†’ Change visibility"
                  exit 1
                fi
              else
                echo "âŒ Error: Failed to pull image (package is private and no token available)"
                echo "Image: $IMAGE_TAG"
                echo "ðŸ’¡ Solutions:"
                echo "   1. Make package public: Settings â†’ Packages â†’ [package] â†’ Package settings â†’ Change visibility"
                echo "   2. Or ensure GITHUB_TOKEN is available (should be automatic in workflows)"
                exit 1
              fi
            fi
            
            # Tag for local use
            echo "ðŸ·ï¸  Tagging image..."
            docker tag "$IMAGE_TAG" lianel-profile-service:latest || {
              echo "âŒ Error: Failed to tag image"
              exit 1
            }
            
            # Verify tag was created
            if ! docker images | grep -q "lianel-profile-service.*latest"; then
              echo "âŒ Error: Tag verification failed"
              docker images | grep profile-service
              exit 1
            fi
            echo "âœ… Image tagged successfully"
            
            # Ensure network exists
            echo "ðŸŒ Ensuring network exists..."
            docker network create lianel-network 2>/dev/null || true
            if ! docker network inspect lianel-network >/dev/null 2>&1; then
              echo "âŒ Error: Failed to create/verify network"
              exit 1
            fi
            echo "âœ… Network verified"
            
            # Stop and remove existing container
            echo "ðŸ›‘ Stopping existing container..."
            docker stop lianel-profile-service 2>/dev/null || true
            docker rm lianel-profile-service 2>/dev/null || true
            
            # Deploy using multiple compose files to include keycloak dependency
            echo "ðŸš€ Deploying profile service container..."
            if command -v docker-compose >/dev/null 2>&1; then
              docker-compose -f docker-compose.infra.yaml -f docker-compose.backend.yaml up -d --no-build profile-service || {
                echo "âŒ Error: docker-compose failed"
                docker-compose -f docker-compose.infra.yaml -f docker-compose.backend.yaml config
                exit 1
              }
            else
              docker compose -f docker-compose.infra.yaml -f docker-compose.backend.yaml up -d --no-build profile-service || {
                echo "âŒ Error: docker compose failed"
                docker compose -f docker-compose.infra.yaml -f docker-compose.backend.yaml config
                exit 1
              }
            fi
            
            # Verify deployment
            echo "=== Verifying deployment ==="
            sleep 5
            if ! docker ps | grep -q lianel-profile-service; then
              echo "âŒ Error: Container not running"
              docker ps -a | grep profile-service
              docker logs lianel-profile-service --tail 50 || true
              exit 1
            fi
            echo "âœ… Container is running"
            
            # Health check
            echo "ðŸ¥ Performing health check..."
            sleep 10  # Wait for service to start
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://lianel-profile-service:3000/health 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "000" ]; then
              echo "âš ï¸  Warning: Health check returned HTTP $HTTP_CODE (expected 200)"
              echo "Container logs:"
              docker logs lianel-profile-service --tail 30
            else
              echo "âœ… Health check passed: HTTP $HTTP_CODE"
            fi
            
            # Clean up old images
            echo "=== Cleaning up ==="
            docker image prune -f
            
            echo "=== âœ… Deployment successful ==="
          EOF

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Profile Service Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.REGISTRY }}/${{ steps.image-name.outputs.image_name }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- **Language**: Rust" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed to**: \`${{ secrets.REMOTE_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Storage Optimized**: âœ… No artifacts, direct registry pull" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
