name: Deploy Profile Service to Production

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'lianel/dc/profile-service/**'
      - 'lianel/dc/docker-compose.backend.yaml'
      - 'lianel/dc/docker-compose.yaml'
      - '.github/workflows/deploy-profile-service.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/lianel-profile-service

jobs:
  build-and-deploy:
    name: Build and Deploy Profile Service
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            lianel/dc/profile-service/target/
          key: ${{ runner.os }}-rust-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-rust-

      - name: Verify Rust code compiles
        working-directory: ./lianel/dc/profile-service
        run: |
          echo "Checking Rust code compilation..."
          # Just check syntax, don't build for musl (Dockerfile will handle that)
          cargo check
          echo "âœ… Rust code compiles successfully"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        id: build
        with:
          context: ./lianel/dc/profile-service
          file: ./lianel/dc/profile-service/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify build succeeded
        run: |
          if [ "${{ steps.build.outcome }}" != "success" ]; then
            echo "Error: Docker build failed"
            exit 1
          fi
          echo "âœ… Docker build and push completed successfully"
          echo "Image tags: ${{ steps.meta.outputs.tags }}"

      - name: Save Docker image as tar.gz
        run: |
          # Extract image tag - prefer latest, otherwise use first tag
          IMAGE_TAGS="${{ steps.meta.outputs.tags }}"
          echo "Available tags: $IMAGE_TAGS"
          
          # Get the first tag (should be latest for default branch)
          IMAGE_TAG=$(echo "$IMAGE_TAGS" | awk '{print $1}')
          
          if [ -z "$IMAGE_TAG" ]; then
            echo "Error: Could not extract image tag from: $IMAGE_TAGS"
            exit 1
          fi
          
          echo "Using image tag: $IMAGE_TAG"
          
          # Wait a moment for registry to be ready, then pull with retries
          echo "Waiting for registry to be ready..."
          sleep 5
          
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempting to pull image (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
            if docker pull "$IMAGE_TAG"; then
              echo "âœ… Successfully pulled image"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Pull failed, waiting 10 seconds before retry..."
                sleep 10
              else
                echo "âŒ Error: Failed to pull image $IMAGE_TAG after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
          
          echo "Saving image: $IMAGE_TAG"
          docker save "$IMAGE_TAG" | gzip > profile-service-image.tar.gz
          
          # Verify the file was created and has content
          if [ ! -f profile-service-image.tar.gz ]; then
            echo "âŒ Error: Failed to create image archive"
            exit 1
          fi
          
          if [ ! -s profile-service-image.tar.gz ]; then
            echo "âŒ Error: Image archive is empty"
            exit 1
          fi
          
          ls -lh profile-service-image.tar.gz
          echo "âœ… Image archive created successfully"

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: profile-service-docker-image
          path: profile-service-image.tar.gz
          retention-days: 7

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.REMOTE_HOST }}" ]; then
            echo "âŒ Error: REMOTE_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.REMOTE_USER }}" ]; then
            echo "âŒ Error: REMOTE_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ Error: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Setup SSH Key
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          if [ -n "$REMOTE_HOST" ]; then
            ssh-keyscan -H "$REMOTE_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
          fi

      - name: Test SSH Connection
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} "echo 'SSH connection successful'"

      - name: Deploy to Remote Host
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -P ${REMOTE_PORT} profile-service-image.tar.gz ${REMOTE_USER}@${REMOTE_HOST}:/root/lianel/dc/

      - name: Load and Deploy on Remote Host
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} '
            set -e
            echo "=== Loading Docker image ==="
            cd /root/lianel/dc
            
            docker load < profile-service-image.tar.gz
            
            # Find the loaded image - check all images and find the one that was just loaded
            # Get images sorted by creation time (newest first)
            LOADED_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" --filter "dangling=false" | grep -v "REPOSITORY" | head -1)
            
            if [ -z "$LOADED_IMAGE" ] || [ "$LOADED_IMAGE" = "REPOSITORY:TAG" ]; then
              echo "Warning: Could not automatically detect loaded image, trying alternative method..."
              # Alternative: check for images with our expected patterns
              LOADED_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "(lianel-profile-service|hosting-base|nimalan74|ghcr.io)" | grep -v "<none>" | head -1)
            fi
            
            if [ -n "$LOADED_IMAGE" ] && [ "$LOADED_IMAGE" != "REPOSITORY:TAG" ]; then
              echo "Found loaded image: $LOADED_IMAGE"
              echo "Tagging as: lianel-profile-service:latest"
              docker tag "$LOADED_IMAGE" lianel-profile-service:latest
              echo "âœ… Image tagged successfully"
            else
              echo "âŒ Error: Could not find loaded image to tag"
              echo "Available images:"
              docker images --format "{{.Repository}}:{{.Tag}}"
              exit 1
            fi
            
            echo "=== Deploying profile service container ==="
            # Try docker compose (v2) first, fallback to docker-compose (v1)
            if command -v docker > /dev/null && docker compose version > /dev/null 2>&1; then
              docker compose -f docker-compose.backend.yaml up -d profile-service
            elif command -v docker-compose > /dev/null; then
              docker-compose -f docker-compose.backend.yaml up -d profile-service
            else
              echo "Error: Neither 'docker compose' nor 'docker-compose' found"
              exit 1
            fi
            
            echo "=== Verifying deployment ==="
            sleep 5
            docker ps | grep lianel-profile-service || exit 1
            
            echo "=== Testing health endpoint ==="
            sleep 5
            # Try multiple methods to test health
            if docker exec lianel-profile-service wget -q -O- http://localhost:3000/health > /dev/null 2>&1; then
              echo "Health check passed (wget)"
            elif docker exec lianel-profile-service curl -f http://localhost:3000/health > /dev/null 2>&1; then
              echo "Health check passed (curl)"
            else
              echo "Warning: Health check failed, but container is running"
              docker logs lianel-profile-service --tail 20
            fi
            
            echo "=== Cleaning up ==="
            docker image prune -f
            rm -f profile-service-image.tar.gz
            
            echo "=== Deployment successful ==="
          '

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Profile Service Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ steps.meta.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- **Language**: Rust" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed to**: \`${{ secrets.REMOTE_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY

