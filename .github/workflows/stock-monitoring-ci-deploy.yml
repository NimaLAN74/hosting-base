# Stock Monitoring backend: CI (test + build) then CD (image push + deploy). All runs on remote via pipeline.
# CI: migrations 022/023, cargo test (config/DB + API), cargo build. CD: Docker build/push, deploy, migration on prod, health verify.
name: Stock Monitoring Backend – CI and Deploy

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'lianel/dc/stock-monitoring/backend/**'
      - 'lianel/dc/database/migrations/022_stock_monitoring_schema.sql'
      - 'lianel/dc/database/migrations/023_stock_monitoring_notifications.sql'
      - 'lianel/dc/docker-compose.stock-monitoring.yaml'
      - 'lianel/dc/scripts/deployment/deploy-stock-monitoring-backend.sh'
      - 'lianel/dc/dags/stock_monitoring_ingest_dag.py'
      - 'lianel/dc/dags/stock_monitoring_alerts_dag.py'
      - 'lianel/dc/nginx/config/nginx.conf'
      - '.github/workflows/stock-monitoring-ci-deploy.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  ci:
    name: CI (test + build)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for Postgres
        run: |
          for i in $(seq 1 30); do
            if PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d postgres -c "SELECT 1" -q 2>/dev/null; then
              echo "Postgres ready"; break
            fi
            [ "$i" -eq 30 ] && { echo "Postgres not ready"; exit 1; }
            sleep 1
          done

      - name: Run migrations 022/023 (stock_monitoring schema + notifications)
        env:
          PGPASSWORD: postgres
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq postgresql-client
          psql -h 127.0.0.1 -U postgres -d postgres -v ON_ERROR_STOP=1 \
            -f lianel/dc/database/migrations/022_stock_monitoring_schema.sql
          psql -h 127.0.0.1 -U postgres -d postgres -v ON_ERROR_STOP=1 \
            -f lianel/dc/database/migrations/023_stock_monitoring_notifications.sql
          echo "✅ Migrations 022/023 applied"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: lianel/dc/stock-monitoring/backend

      - name: Run tests (config, DB pool, schema, API /health and /api/v1/status)
        env:
          POSTGRES_HOST: 127.0.0.1
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        run: |
          cd lianel/dc/stock-monitoring/backend && cargo test

      - name: Build release binary
        env:
          POSTGRES_HOST: 127.0.0.1
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        run: |
          cd lianel/dc/stock-monitoring/backend && cargo build --release
          echo "✅ Binary built"

      - name: Set image name
        id: image-name
        run: |
          IMAGE_NAME_LC=$(echo "${{ github.repository }}/lianel-stock-monitoring-service" | tr '[:upper:]' '[:lower:]')
          echo "image_name=${IMAGE_NAME_LC}" >> $GITHUB_OUTPUT
          echo "IMAGE_NAME_LC=${IMAGE_NAME_LC}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./lianel/dc/stock-monitoring/backend
          file: ./lianel/dc/stock-monitoring/backend/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ env.REGISTRY }}/${{ steps.image-name.outputs.image_name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Make package public
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PACKAGE_NAME="${{ steps.image-name.outputs.image_name }}"
          ENCODED=$(echo "$PACKAGE_NAME" | sed 's/\//%2F/g')
          gh api -X PATCH "/user/packages/container/${ENCODED}" -f visibility=public 2>/dev/null || \
          gh api -X PATCH "/orgs/$(echo $PACKAGE_NAME | cut -d'/' -f1)/packages/container/$(echo $PACKAGE_NAME | cut -d'/' -f2- | sed 's/\//%2F/g')" -f visibility=public 2>/dev/null || true
          echo "✅ Package visibility updated or skipped"

  cd:
    name: CD (build image, push, deploy, verify)
    needs: ci
    runs-on: ubuntu-latest
    if: success() && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate secrets
        run: |
          [ -n "${{ secrets.REMOTE_HOST }}" ] || { echo "❌ REMOTE_HOST not set"; exit 1; }
          [ -n "${{ secrets.REMOTE_USER }}" ] || { echo "❌ REMOTE_USER not set"; exit 1; }
          [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ] || { echo "❌ SSH_PRIVATE_KEY not set"; exit 1; }
          echo "✅ Secrets configured"

      - name: Setup SSH
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$REMOTE_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "✅ SSH ready"

      - name: Copy deploy script and compose to remote
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -P ${REMOTE_PORT} \
            lianel/dc/scripts/deployment/deploy-stock-monitoring-backend.sh \
            lianel/dc/docker-compose.stock-monitoring.yaml lianel/dc/docker-compose.infra.yaml \
            lianel/dc/dags/stock_monitoring_ingest_dag.py lianel/dc/dags/stock_monitoring_alerts_dag.py \
            ${REMOTE_USER}@${REMOTE_HOST}:/tmp/
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} \
            "chmod +x /tmp/deploy-stock-monitoring-backend.sh && for d in /root/hosting-base/lianel/dc /root/lianel/dc; do [ -d \"\$d\" ] || continue; cp /tmp/docker-compose.stock-monitoring.yaml /tmp/docker-compose.infra.yaml \"\$d/\" 2>/dev/null; mkdir -p \"\$d/dags\"; cp /tmp/stock_monitoring_ingest_dag.py /tmp/stock_monitoring_alerts_dag.py \"\$d/dags/\" 2>/dev/null; echo \"Updated \$d\"; done"
          echo "✅ Script and compose synced"

      - name: Deploy to remote host (stock backend only)
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO_LC=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_LC="${{ env.REGISTRY }}/${REPO_LC}/lianel-stock-monitoring-service:latest"
          echo "Deploying: $IMAGE_LC"
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -p ${REMOTE_PORT} \
            ${REMOTE_USER}@${REMOTE_HOST} \
            "GITHUB_TOKEN='${GITHUB_TOKEN}' GITHUB_ACTOR='${{ github.actor }}' /tmp/deploy-stock-monitoring-backend.sh '$IMAGE_LC'"
          echo "✅ Deployed"

      - name: Run migrations 022/023 on production DB
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
        run: |
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -P ${REMOTE_PORT} \
            lianel/dc/database/migrations/022_stock_monitoring_schema.sql \
            lianel/dc/database/migrations/023_stock_monitoring_notifications.sql \
            ${REMOTE_USER}@${REMOTE_HOST}:/tmp/
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} \
            "set -euo pipefail; \
             DC_DIR=''; \
             for d in /root/hosting-base/lianel/dc /root/lianel/dc; do [ -f \"\$d/.env\" ] && DC_DIR=\"\$d\" && break; done; \
             [ -n \"\$DC_DIR\" ] && . \"\$DC_DIR/.env\" 2>/dev/null || true; \
             DB_HOST=\${POSTGRES_HOST:-172.18.0.1}; \
             DB_APP_USER=\${POSTGRES_USER:-airflow}; \
             DB_APP_PASS=\${POSTGRES_PASSWORD:-postgres}; \
             DB_MIG_USER=\${POSTGRES_MIGRATION_USER:-postgres}; \
             DB_MIG_PASS=\${POSTGRES_MIGRATION_PASSWORD:-\$DB_APP_PASS}; \
             DB_NAME=\${POSTGRES_DB_STOCK_MONITORING:-lianel_stock_monitoring}; \
             DB_ADMIN_DB=\${POSTGRES_ADMIN_DB:-postgres}; \
             echo \"Applying migrations 022/023 to \$DB_MIG_USER@\$DB_HOST/\$DB_NAME (app user: \$DB_APP_USER)\"; \
             if ! docker run --rm --network host -e PGPASSWORD=\"\$DB_MIG_PASS\" postgres:15-alpine \
               psql -h \"\$DB_HOST\" -U \"\$DB_MIG_USER\" -d \"\$DB_ADMIN_DB\" -tAc \"SELECT 1 FROM pg_database WHERE datname = '\$DB_NAME'\" | grep -q 1; then \
               docker run --rm --network host -e PGPASSWORD=\"\$DB_MIG_PASS\" postgres:15-alpine \
                 psql -h \"\$DB_HOST\" -U \"\$DB_MIG_USER\" -d \"\$DB_ADMIN_DB\" -v ON_ERROR_STOP=1 -c \"CREATE DATABASE \\\"\$DB_NAME\\\"\"; \
             fi; \
             if ! (docker run --rm --network host -v /tmp/022_stock_monitoring_schema.sql:/tmp/022_stock_monitoring_schema.sql:ro -e PGPASSWORD=\"\$DB_MIG_PASS\" postgres:15-alpine \
               psql -h \"\$DB_HOST\" -U \"\$DB_MIG_USER\" -d \"\$DB_NAME\" -v ON_ERROR_STOP=1 -f /tmp/022_stock_monitoring_schema.sql && \
               docker run --rm --network host -v /tmp/023_stock_monitoring_notifications.sql:/tmp/023_stock_monitoring_notifications.sql:ro -e PGPASSWORD=\"\$DB_MIG_PASS\" postgres:15-alpine \
               psql -h \"\$DB_HOST\" -U \"\$DB_MIG_USER\" -d \"\$DB_NAME\" -v ON_ERROR_STOP=1 -f /tmp/023_stock_monitoring_notifications.sql); then \
               echo \"⚠️ Migration with \$DB_MIG_USER failed, retrying with app user \$DB_APP_USER\"; \
               docker run --rm --network host -v /tmp/022_stock_monitoring_schema.sql:/tmp/022_stock_monitoring_schema.sql:ro -e PGPASSWORD=\"\$DB_APP_PASS\" postgres:15-alpine \
                 psql -h \"\$DB_HOST\" -U \"\$DB_APP_USER\" -d \"\$DB_NAME\" -v ON_ERROR_STOP=1 -f /tmp/022_stock_monitoring_schema.sql; \
               docker run --rm --network host -v /tmp/023_stock_monitoring_notifications.sql:/tmp/023_stock_monitoring_notifications.sql:ro -e PGPASSWORD=\"\$DB_APP_PASS\" postgres:15-alpine \
                 psql -h \"\$DB_HOST\" -U \"\$DB_APP_USER\" -d \"\$DB_NAME\" -v ON_ERROR_STOP=1 -f /tmp/023_stock_monitoring_notifications.sql; \
             fi; \
             docker run --rm --network host -e PGPASSWORD=\"\$DB_APP_PASS\" postgres:15-alpine \
               psql -h \"\$DB_HOST\" -U \"\$DB_APP_USER\" -d \"\$DB_NAME\" -v ON_ERROR_STOP=1 -tAc \"SELECT to_regclass('stock_monitoring.watchlists')\" | grep -q 'stock_monitoring.watchlists'; \
             docker run --rm --network host -e PGPASSWORD=\"\$DB_APP_PASS\" postgres:15-alpine \
               psql -h \"\$DB_HOST\" -U \"\$DB_APP_USER\" -d \"\$DB_NAME\" -v ON_ERROR_STOP=1 -c \"SELECT 1 FROM stock_monitoring.notifications LIMIT 1\" >/dev/null"
          echo "✅ Migrations 022/023 on production"

      - name: Restart stock backend after DB migration
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} \
            "set -e; DC_DIR=; for d in /root/hosting-base/lianel/dc /root/lianel/dc; do [ -f \"\$d/docker-compose.stock-monitoring.yaml\" ] && DC_DIR=\"\$d\" && break; done; \
             [ -n \"\$DC_DIR\" ] || { echo 'No compose dir found'; exit 1; }; \
             cd \"\$DC_DIR\"; \
             docker compose -f docker-compose.infra.yaml -f docker-compose.stock-monitoring.yaml up -d --force-recreate --no-deps stock-monitoring-service; \
             sleep 5; docker compose -f docker-compose.infra.yaml -f docker-compose.stock-monitoring.yaml ps stock-monitoring-service"
          echo "✅ Stock backend restarted after migration"

      - name: Verify deployment (health)
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${REMOTE_PORT} \
            ${REMOTE_USER}@${REMOTE_HOST} \
            "set -e; for i in \$(seq 1 15); do docker exec lianel-stock-monitoring-service curl -fsS http://localhost:3003/health && exit 0; sleep 3; done; exit 1" || \
          { echo "❌ Health check failed after retries"; exit 1; }
          echo "✅ Health check passed (HTTPS exposure when nginx location added in 1.6)"

      - name: Summary
        run: |
          echo "## Stock Monitoring Backend – CI and CD" >> $GITHUB_STEP_SUMMARY
          echo "- **CI**: migrations 022/023 + cargo test (config, DB, schema, API /health, /api/v1/status)" >> $GITHUB_STEP_SUMMARY
          echo "- **CD**: image push, deploy, migrations on prod, health verify" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ env.REGISTRY }}/${{ github.repository }}/lianel-stock-monitoring-service:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy**: \`${{ secrets.REMOTE_HOST }}\`" >> $GITHUB_STEP_SUMMARY
