# Sync nginx config to fix login: /auth/ and /resources/ must go to Keycloak on www.lianel.se.
# Run this when you cannot log in (login page shows React app or CSS/400 errors).
name: Sync Nginx (Fix Login)

on:
  workflow_dispatch:

jobs:
  sync-nginx:
    name: Push nginx.conf to server and reload
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.REMOTE_HOST }}" ] || [ -z "${{ secrets.REMOTE_USER }}" ] || [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "❌ REMOTE_HOST, REMOTE_USER, SSH_PRIVATE_KEY must be set"
            exit 1
          fi
          echo "✅ Secrets configured"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key && chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$REMOTE_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "✅ SSH ready"

      - name: Preflight SSH (retry on timeout)
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
        run: |
          for i in 1 2 3 4 5; do
            if ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -o ConnectTimeout=45 -p ${REMOTE_PORT} ${REMOTE_USER}@${REMOTE_HOST} "echo ok"; then
              echo "✅ SSH reachable (attempt $i)"
              exit 0
            fi
            echo "⚠️ SSH attempt $i failed (timeout or refused); retrying in 30s..."
            [ $i -lt 5 ] && sleep 30
          done
          echo "❌ SSH to ${REMOTE_HOST} failed after 5 attempts. Server may be down or firewall blocking GitHub Actions IPs."
          echo "→ Run fix manually on server: bash /root/lianel/dc/scripts/fix-502-keycloak-on-server.sh"
          exit 1

      - name: "Apply on remote (fix 502: sync DB + start Keycloak, then nginx + KC_HOSTNAME, reload, frontendUrl)"
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
        run: |
          set -e
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -o ConnectTimeout=30 \
            -p "${REMOTE_PORT}" \
            "${REMOTE_USER}@${REMOTE_HOST}" '
            set -e
            echo "=== 1. Get latest from git on server ==="
            REPO=""
            for base in /root/hosting-base /root /opt; do
              [ -f "$base/lianel/dc/docker-compose.infra.yaml" ] && REPO="$base" && break
              [ -f "$base/hosting-base/lianel/dc/docker-compose.infra.yaml" ] && REPO="$base/hosting-base" && break
            done
            if [ -n "$REPO" ]; then
              cd "$REPO" && git fetch origin 2>/dev/null; git checkout origin/master -- lianel/dc/nginx/config/nginx.conf lianel/dc/docker-compose.infra.yaml 2>/dev/null || git checkout origin/main -- lianel/dc/nginx/config/nginx.conf lianel/dc/docker-compose.infra.yaml 2>/dev/null || true
              echo "  Repo: $REPO"
            fi
            echo "=== 2. Nginx + compose into /root/lianel/dc ==="
            mkdir -p /root/lianel/dc/nginx/config
            for base in /root/hosting-base /root; do
              [ -f "$base/lianel/dc/nginx/config/nginx.conf" ] && cp "$base/lianel/dc/nginx/config/nginx.conf" /root/lianel/dc/nginx/config/ && break
              [ -f "$base/hosting-base/lianel/dc/nginx/config/nginx.conf" ] && cp "$base/hosting-base/lianel/dc/nginx/config/nginx.conf" /root/lianel/dc/nginx/config/ && break
            done
            for base in /root/hosting-base /root; do
              [ -f "$base/lianel/dc/docker-compose.infra.yaml" ] && cp "$base/lianel/dc/docker-compose.infra.yaml" /root/lianel/dc/ && break
              [ -f "$base/hosting-base/lianel/dc/docker-compose.infra.yaml" ] && cp "$base/hosting-base/lianel/dc/docker-compose.infra.yaml" /root/lianel/dc/ && break
            done
            echo "=== 3. Force KC_HOSTNAME in all compose copies ==="
            for d in /root/lianel/dc /root/hosting-base/lianel/dc; do
              [ -f "$d/docker-compose.infra.yaml" ] || continue
              sed -i "s|KC_HOSTNAME:.*|KC_HOSTNAME: https://www.lianel.se/auth|" "$d/docker-compose.infra.yaml"
              sed -i "s|KC_HOSTNAME_ADMIN:.*|KC_HOSTNAME_ADMIN: https://auth.lianel.se|" "$d/docker-compose.infra.yaml"
              grep -E "KC_HOSTNAME" "$d/docker-compose.infra.yaml" | head -2
            done
            echo "=== 4. Fix 502: sync Keycloak DB password and start Keycloak ==="
            bash /root/hosting-base/lianel/dc/scripts/maintenance/set-keycloak-db-password-on-server.sh 2>/dev/null || true
            DC_DIR="/root/hosting-base/lianel/dc"
            [ -f /root/lianel/dc/docker-compose.infra.yaml ] && DC_DIR="/root/lianel/dc"
            KEYCOWNER=$(docker inspect keycloak --format "{{ index .Config.Labels \"com.docker.compose.project.working_dir\" }}" 2>/dev/null) || true
            [ -n "$KEYCOWNER" ] && [ -f "$KEYCOWNER/docker-compose.infra.yaml" ] && DC_DIR="$KEYCOWNER" || true
            echo "  Using compose dir: $DC_DIR"
            (cd "$DC_DIR" && docker compose -f docker-compose.infra.yaml up -d keycloak)
            echo "  Waiting 45s for Keycloak to start..."
            sleep 45
            echo "=== 5. Reload nginx (sub_filter rewrites auth.lianel.se -> www.lianel.se/auth in HTML) ==="
            docker exec nginx-proxy nginx -t && docker exec nginx-proxy nginx -s reload
            echo "=== 6. Set realm frontendUrl (if Keycloak is up) ==="
            for dc in /root/hosting-base/lianel/dc /root/lianel/dc; do
              [ -f "$dc/scripts/keycloak-setup/fix-keycloak-https.sh" ] || continue
              (cd "$dc" && [ -f .env ] && source .env; export KEYCLOAK_URL=https://auth.lianel.se; export KEYCLOAK_FRONTEND_URL=https://www.lianel.se/auth; bash scripts/keycloak-setup/fix-keycloak-https.sh) 2>/dev/null && break || true
            done
            docker ps --filter name=keycloak --format "table {{.Names}}\t{{.Status}}"
            echo "✅ Remote apply done"
          '
          echo "✅ Config applied, Keycloak started, nginx reloaded"

      # Deploy the exact nginx.conf from this run (runner checkout). Server git may be behind; this ensures the fix is live.
      - name: Copy nginx.conf from runner to server and reload
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
        run: |
          set -e
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -P "${REMOTE_PORT}" \
            lianel/dc/nginx/config/nginx.conf "${REMOTE_USER}@${REMOTE_HOST}:/root/lianel/dc/nginx/config/nginx.conf"
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -p "${REMOTE_PORT}" "${REMOTE_USER}@${REMOTE_HOST}" \
            "docker exec nginx-proxy nginx -t && docker exec nginx-proxy nginx -s reload"
          echo "✅ Runner nginx.conf deployed and reloaded"

      - name: Verify theme CSS (200 + text/css) – fail job if wrong
        run: |
          echo "Waiting 15s for Keycloak to be ready..."
          sleep 15
          for attempt in 1 2 3; do
            echo "Theme CSS verification attempt $attempt..."
            if bash lianel/dc/scripts/monitoring/verify-keycloak-www-resources.sh; then
              echo "✅ Theme CSS OK"
              exit 0
            fi
            [ $attempt -lt 3 ] && echo "Retry in 20s..." && sleep 20
          done
          echo "❌ Theme CSS not 200/text/css after 3 attempts; deploy or config may be wrong"
          exit 1

      - name: Verify /auth/ goes to Keycloak
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
        run: |
          echo "Waiting 5s for nginx/Keycloak..."
          sleep 5
          SIZE=$(curl -s -k -o /tmp/auth_check.html -w "%{size_download}" "https://www.lianel.se/auth/realms/lianel/protocol/openid-connect/auth?client_id=frontend-client&redirect_uri=https%3A%2F%2Fwww.lianel.se%2F&response_type=code&scope=openid" -L 2>/dev/null || echo "0")
          if [ "$SIZE" -gt 5000 ] 2>/dev/null; then
            echo "✅ Login page looks like Keycloak (response size ${SIZE} bytes)"
          elif [ "$SIZE" -gt 0 ]; then
            echo "⚠️ Response size ${SIZE} bytes (expected >5000 for Keycloak HTML)"
          else
            echo "⚠️ Could not reach www.lianel.se (curl failed or 0 bytes)"
          fi

      - name: Run E2E login flow test (must pass)
        run: |
          echo "Waiting 20s for Keycloak to serve new hostname..."
          sleep 20
          for attempt in 1 2 3; do
            echo "E2E attempt $attempt..."
            if bash lianel/dc/scripts/monitoring/e2e-test-www-login-flow.sh; then
              echo "✅ E2E login flow passed"
              exit 0
            fi
            [ $attempt -lt 3 ] && echo "Retry in 15s..." && sleep 15
          done
          echo "❌ E2E failed after 3 attempts"
          exit 1

      - name: Summary
        run: |
          echo "## Login fix applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Nginx**: \`/auth/\`, \`/realms/\`, \`/resources/\` on www → Keycloak" >> $GITHUB_STEP_SUMMARY
          echo "- **Keycloak**: \`KC_HOSTNAME=https://www.lianel.se/auth\` so login form POST is same-origin" >> $GITHUB_STEP_SUMMARY
          echo "- **Next**: Open https://www.lianel.se in a **new tab** and log in." >> $GITHUB_STEP_SUMMARY
