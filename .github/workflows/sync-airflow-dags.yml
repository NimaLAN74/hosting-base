name: Sync Airflow DAGs to Remote Host

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'lianel/dc/dags/**'
      - '.github/workflows/sync-airflow-dags.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
  REMOTE_USER: ${{ secrets.REMOTE_USER }}
  REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}

jobs:
  sync-dags:
    name: Sync DAGs to Remote Host
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.REMOTE_HOST }}" ]; then
            echo "âŒ Error: REMOTE_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.REMOTE_USER }}" ]; then
            echo "âŒ Error: REMOTE_USER secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ Error: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Setup SSH Key
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write SSH key
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Verify key format
          if ! grep -q "^-----BEGIN" ~/.ssh/deploy_key; then
            echo "âŒ Error: SSH key format is incorrect"
            exit 1
          fi
          
          if [ -n "$REMOTE_HOST" ]; then
            ssh-keyscan -H "$REMOTE_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
          fi
          
          echo "âœ… SSH key ready"

      - name: Sync DAG Files
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
        run: |
          echo "Syncing DAG files to remote host..."
          
          # Create DAGs directory if it doesn't exist
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -p ${REMOTE_PORT} \
            ${REMOTE_USER}@${REMOTE_HOST} \
            "mkdir -p /root/lianel/dc/dags && chmod 755 /root/lianel/dc/dags"
          
          # Sync all DAG files
          rsync -avz \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -p ${REMOTE_PORT}" \
            --delete \
            lianel/dc/dags/ \
            ${REMOTE_USER}@${REMOTE_HOST}:/root/lianel/dc/dags/
          
          echo "âœ… DAG files synced successfully"

      - name: Verify DAG Files
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
        run: |
          echo "Verifying DAG files on remote host..."
          
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=~/.ssh/known_hosts \
            -p ${REMOTE_PORT} \
            ${REMOTE_USER}@${REMOTE_HOST} \
            "ls -la /root/lianel/dc/dags/*.py | wc -l && echo 'DAG files found'"
          
          echo "âœ… Verification complete"

      - name: Sync Summary
        run: |
          echo "## ðŸ”„ Airflow DAGs Synced" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: Repository DAGs directory" >> $GITHUB_STEP_SUMMARY
          echo "- **Destination**: \`${{ secrets.REMOTE_HOST }}:/root/lianel/dc/dags/\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "DAG files will be automatically detected by Airflow scheduler." >> $GITHUB_STEP_SUMMARY
