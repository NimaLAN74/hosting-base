name: Remote Disk Cleanup

on:
  workflow_dispatch:
    inputs:
      prune_volumes:
        description: "Also prune unused Docker volumes (can remove dangling app data)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  cleanup:
    name: Cleanup remote Docker disk usage
    runs-on: ubuntu-latest
    steps:
      - name: Validate secrets
        run: |
          [ -n "${{ secrets.REMOTE_HOST }}" ] || { echo "REMOTE_HOST missing"; exit 1; }
          [ -n "${{ secrets.REMOTE_USER }}" ] || { echo "REMOTE_USER missing"; exit 1; }
          [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ] || { echo "SSH_PRIVATE_KEY missing"; exit 1; }

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.REMOTE_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Run cleanup on remote host
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT || '22' }}
          PRUNE_VOLUMES: ${{ github.event.inputs.prune_volumes }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -p "${REMOTE_PORT}" "${REMOTE_USER}@${REMOTE_HOST}" "PRUNE_VOLUMES='${PRUNE_VOLUMES}' bash -s" <<'EOF'
          set -e
          echo '==== DISK BEFORE ===='
          df -h /
          echo
          echo '==== DOCKER BEFORE ===='
          docker system df
          echo
          echo '==== PRUNING UNUSED RESOURCES ===='
          docker container prune -f
          docker image prune -a -f
          docker network prune -f
          docker builder prune -a -f
          if [ "${PRUNE_VOLUMES}" = "true" ]; then
            echo 'Pruning unused volumes as requested...'
            docker volume prune -f
          else
            echo 'Skipping docker volume prune (default).'
          fi
          echo
          echo '==== DISK AFTER ===='
          df -h /
          echo
          echo '==== DOCKER AFTER ===='
          docker system df
          EOF

      - name: Summary
        run: |
          echo "## Remote Disk Cleanup" >> "$GITHUB_STEP_SUMMARY"
          echo "- Completed Docker cleanup on remote host" >> "$GITHUB_STEP_SUMMARY"
          echo "- Pruned: containers, images, networks, builder cache" >> "$GITHUB_STEP_SUMMARY"
          echo "- Volumes pruned: \`${{ github.event.inputs.prune_volumes }}\`" >> "$GITHUB_STEP_SUMMARY"
