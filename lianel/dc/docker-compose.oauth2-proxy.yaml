services:
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: keycloak
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://host.docker.internal:5432/keycloak
      KC_DB_USERNAME: ${KEYCLOAK_DB_USER}
      KC_DB_PASSWORD: ${KEYCLOAK_DB_PASSWORD}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USER}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_HOSTNAME: auth.lianel.se
      KC_HOSTNAME_STRICT: "false"
      KC_PROXY_HEADERS: xforwarded
      KC_HTTP_ENABLED: "true"
      KC_HEALTH_ENABLED: "true"
    command: start
    extra_hosts:
      - "host.docker.internal:host-gateway"
    expose:
      - "8080"
    networks:
      - lianel-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    container_name: oauth2-proxy
    environment:
      OAUTH2_PROXY_PROVIDER: keycloak-oidc
      OAUTH2_PROXY_CLIENT_ID: ${OAUTH2_CLIENT_ID}
      OAUTH2_PROXY_CLIENT_SECRET: ${OAUTH2_CLIENT_SECRET}
      # OAUTH2_PROXY_REDIRECT_URL not set - will use request host dynamically
      OAUTH2_PROXY_OIDC_ISSUER_URL: https://auth.lianel.se/realms/lianel
      OAUTH2_PROXY_COOKIE_SECRET: ${OAUTH2_COOKIE_SECRET}
      OAUTH2_PROXY_COOKIE_SECURE: "true"
      OAUTH2_PROXY_COOKIE_DOMAIN: .lianel.se
      OAUTH2_PROXY_COOKIE_SAMESITE: lax
      OAUTH2_PROXY_CODE_CHALLENGE_METHOD: S256
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_UPSTREAMS: static://200
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
      OAUTH2_PROXY_WHITELIST_DOMAINS: .lianel.se
      OAUTH2_PROXY_COOKIE_REFRESH: 1h
      OAUTH2_PROXY_COOKIE_EXPIRE: 4h
      OAUTH2_PROXY_PASS_ACCESS_TOKEN: "true"
      OAUTH2_PROXY_PASS_USER_HEADERS: "true"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_USER_ID_CLAIM: "preferred_username"
      OAUTH2_PROXY_OIDC_GROUPS_CLAIM: "groups"
      OAUTH2_PROXY_BACKEND_LOGOUT_URL: "https://auth.lianel.se/realms/lianel/protocol/openid-connect/logout?post_logout_redirect_uri=https://www.lianel.se/"
    expose:
      - "4180"
    depends_on:
      - keycloak
    restart: unless-stopped
    networks:
      - lianel-network

networks:
  lianel-network:
    external: true
