#!/bin/bash
# Vulnerability Scanning Script
# Scans Docker images and system for known vulnerabilities

set -e

echo "=========================================="
echo "Vulnerability Scan - Lianel Platform"
echo "Date: $(date)"
echo "=========================================="
echo ""

# Check if trivy is installed
if ! command -v trivy &> /dev/null; then
    echo "Trivy not found. Installing..."
    # Install trivy (example for Linux)
    wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
    echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
    sudo apt-get update
    sudo apt-get install -y trivy
fi

echo "Scanning Docker images..."
echo "-----------------------------------"

# List of images to scan
IMAGES=(
    "quay.io/keycloak/keycloak:26.4.6"
    "nginx:latest"
    "postgres:15"
    "apache/airflow:2.10.0"
    "grafana/grafana:latest"
    "prom/prometheus:latest"
    "grafana/loki:latest"
    "grafana/promtail:latest"
    "quay.io/oauth2-proxy/oauth2-proxy:latest"
)

SCAN_RESULTS="vulnerability-scan-results-$(date +%Y%m%d).txt"

echo "Scan results will be saved to: $SCAN_RESULTS"
echo ""

for image in "${IMAGES[@]}"; do
    echo "Scanning: $image"
    echo "-----------------------------------"
    trivy image --severity HIGH,CRITICAL --format table "$image" | tee -a "$SCAN_RESULTS"
    echo ""
done

echo "Scanning system packages..."
echo "-----------------------------------"

# Scan system for vulnerable packages
if command -v apt &> /dev/null; then
    echo "Checking for system package updates..."
    apt list --upgradable 2>/dev/null | grep -i security | tee -a "$SCAN_RESULTS"
fi

echo ""
echo "=========================================="
echo "Vulnerability Scan Complete"
echo "=========================================="
echo "Results saved to: $SCAN_RESULTS"
echo ""
echo "Review the results and update images/packages as needed."
