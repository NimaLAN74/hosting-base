# Deployment Guide

## Prerequisites

### Server Requirements
- Ubuntu 20.04+ or Debian 11+
- 8 GB RAM minimum
- 2 CPU cores minimum
- 100 GB disk space
- Public IP address
- Root or sudo access

### Software Requirements
```bash
# Docker
Docker Engine 20.10+
Docker Compose 2.0+

# System packages
- curl
- git
- jq
- python3
```

### Domain Requirements
- Domain name (lianel.se)
- DNS access to create A records
- Subdomains configured:
  - www.lianel.se
  - auth.lianel.se
  - airflow.lianel.se
  - monitoring.lianel.se

## Initial Server Setup

### 1. Update System
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install -y curl git jq python3 python3-pip
```

### 2. Install Docker
```bash
# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Add user to docker group
sudo usermod -aG docker $USER

# Install Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# Verify installation
docker --version
docker-compose --version
```

### 3. Configure Firewall
```bash
# Install UFW
sudo apt install -y ufw

# Allow SSH, HTTP, HTTPS
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Enable firewall
sudo ufw --force enable
sudo ufw status
```

### 4. Configure DNS
Create A records pointing to your server IP (72.60.80.84):
```
lianel.se           A    72.60.80.84
www.lianel.se       A    72.60.80.84
auth.lianel.se      A    72.60.80.84
airflow.lianel.se   A    72.60.80.84
monitoring.lianel.se A   72.60.80.84
```

## Application Deployment

### 1. Clone Repository
```bash
cd /root
git clone <repository-url> hosting-base
cd hosting-base/lianel/dc
```

### 2. Configure Environment Variables
```bash
# Copy example env file
cp .env.example .env

# Edit .env file
nano .env
```

**Required Variables**:
```bash
# Airflow
AIRFLOW__CORE__FERNET_KEY=<generate with: python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())">
_AIRFLOW_WWW_USER_PASSWORD=<generate strong password>
POSTGRES_PASSWORD=<generate strong password>

# Keycloak
KEYCLOAK_ADMIN_PASSWORD=<generate strong password>
KEYCLOAK_DB_PASSWORD=<generate strong password>

# OAuth2 Proxy
OAUTH2_CLIENT_SECRET=<will be generated by Keycloak>
OAUTH2_COOKIE_SECRET=<generate with: python -c 'import os,base64; print(base64.urlsafe_b64encode(os.urandom(32)).decode())'>

# Grafana
GRAFANA_ADMIN_PASSWORD=<generate strong password>
GRAFANA_OAUTH_CLIENT_SECRET=<will be generated by Keycloak>

# Redis
REDIS_PASSWORD=<generate strong password>
```

### 3. Setup PostgreSQL (Host-level)
```bash
# Install PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# Create databases and users
sudo -u postgres psql << EOF
CREATE DATABASE airflow;
CREATE USER airflow WITH PASSWORD '<POSTGRES_PASSWORD>';
GRANT ALL PRIVILEGES ON DATABASE airflow TO airflow;

CREATE DATABASE keycloak;
CREATE USER keycloak WITH PASSWORD '<KEYCLOAK_DB_PASSWORD>';
GRANT ALL PRIVILEGES ON DATABASE keycloak TO keycloak;
ALTER DATABASE keycloak OWNER TO keycloak;
\c keycloak
GRANT ALL ON SCHEMA public TO keycloak;
EOF
```

### 4. Create Docker Network
```bash
docker network create lianel-network
```

### 5. Deploy Infrastructure Services
```bash
# Deploy Nginx
docker-compose -f docker-compose.infra.yaml up -d

# Verify
docker ps | grep nginx
```

### 6. Obtain SSL Certificates
```bash
# Install Certbot
sudo apt install -y certbot

# Obtain certificates
sudo certbot certonly --webroot -w /root/lianel/dc/nginx/html \
  -d lianel.se -d www.lianel.se

sudo certbot certonly --webroot -w /root/lianel/dc/nginx/html \
  -d auth.lianel.se

sudo certbot certonly --webroot -w /root/lianel/dc/nginx/html \
  -d airflow.lianel.se

sudo certbot certonly --webroot -w /root/lianel/dc/nginx/html \
  -d monitoring.lianel.se

# Setup auto-renewal
sudo systemctl enable certbot.timer
sudo systemctl start certbot.timer
```

### 7. Deploy Authentication Services
```bash
# Deploy Keycloak and OAuth2 Proxy
docker-compose -f docker-compose.oauth2-proxy.yaml up -d

# Wait for Keycloak to start
sleep 30

# Run Keycloak setup script
chmod +x setup-keycloak.sh
./setup-keycloak.sh

# Update .env with generated secrets
# OAUTH2_CLIENT_SECRET=<from script output>
# GRAFANA_OAUTH_CLIENT_SECRET=<from script output>

# Restart OAuth2 Proxy with new secrets
docker-compose -f docker-compose.oauth2-proxy.yaml restart oauth2-proxy
```

### 8. Deploy Application Services
```bash
# Deploy Frontend
docker-compose -f docker-compose.frontend.yaml up -d

# Deploy Airflow
docker-compose -f docker-compose.airflow.yaml up -d

# Wait for Airflow initialization
docker logs -f dc-airflow-init-1
# Wait until you see "Initialization complete"
```

### 9. Deploy Monitoring Stack
```bash
# Deploy monitoring services
docker-compose -f docker-compose.monitoring.yaml up -d

# Verify all services
docker ps
```

### 10. Enable Docker Metrics
```bash
# Edit Docker daemon config
sudo nano /etc/docker/daemon.json

# Add:
{
  "metrics-addr": "127.0.0.1:9323",
  "experimental": true
}

# Restart Docker
sudo systemctl restart docker

# Restart all containers
cd /root/lianel/dc
docker-compose -f docker-compose.infra.yaml up -d
docker-compose -f docker-compose.oauth2-proxy.yaml up -d
docker-compose -f docker-compose.frontend.yaml up -d
docker-compose -f docker-compose.airflow.yaml up -d
docker-compose -f docker-compose.monitoring.yaml up -d
```

## Post-Deployment Configuration

### 1. Create Keycloak Test User
```bash
# Access Keycloak admin console
# https://auth.lianel.se

# Login with KEYCLOAK_ADMIN credentials
# Navigate to: lianel realm > Users > Add User
# Username: testuser
# Email: test@lianel.se
# Set password in Credentials tab
```

### 2. Configure Grafana Dashboards
```bash
# Access Grafana
# https://www.lianel.se/monitoring/

# Login with SSO (testuser)
# Dashboards should be auto-provisioned
```

### 3. Configure Airflow
```bash
# Access Airflow
# https://airflow.lianel.se

# Login with SSO (testuser)
# Add connections, variables as needed
```

### 4. Reload Nginx
```bash
# After any nginx config changes
docker exec nginx-proxy nginx -s reload
```

## Verification Steps

### 1. Check All Services Running
```bash
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

Expected output: All containers should show "Up" status

### 2. Test SSL Certificates
```bash
curl -I https://www.lianel.se
curl -I https://auth.lianel.se
curl -I https://airflow.lianel.se
curl -I https://monitoring.lianel.se
```

Expected: All should return 200 or 302 status

### 3. Test SSO Flow
1. Visit https://www.lianel.se
2. Should redirect to Keycloak login
3. Login with test user
4. Should redirect back to frontend
5. Visit https://www.lianel.se/monitoring/
6. Should access without additional login

### 4. Check Monitoring
1. Visit https://www.lianel.se/monitoring/
2. Navigate to "Docker Containers (Working)" dashboard
3. Verify metrics are showing

### 5. Check Logs
```bash
# Check for errors
docker logs nginx-proxy --tail 50
docker logs oauth2-proxy --tail 50
docker logs keycloak --tail 50
docker logs grafana --tail 50
docker logs prometheus --tail 50
```

## Troubleshooting

### Issue: Containers Not Starting
```bash
# Check logs
docker logs <container-name>

# Check resources
docker stats

# Check network
docker network inspect lianel-network
```

### Issue: SSL Certificate Errors
```bash
# Verify certificates exist
sudo ls -la /etc/letsencrypt/live/

# Test certificate renewal
sudo certbot renew --dry-run

# Check nginx config
docker exec nginx-proxy nginx -t
```

### Issue: OAuth2 Proxy 502 Errors
```bash
# Check OAuth2 proxy logs
docker logs oauth2-proxy

# Verify Keycloak is accessible
docker exec oauth2-proxy curl -I http://keycloak:8080

# Check nginx buffer sizes in nginx.conf
# Should have: proxy_buffer_size 128k
```

### Issue: Database Connection Errors
```bash
# Check PostgreSQL is running
sudo systemctl status postgresql

# Test connection from container
docker exec keycloak psql -h host.docker.internal -U keycloak -d keycloak

# Check firewall
sudo ufw status
```

### Issue: Monitoring Shows No Data
```bash
# Check Prometheus targets
curl http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | {job: .labels.job, health: .health}'

# Check cAdvisor
curl http://localhost:8080/metrics | grep container_cpu

# Restart monitoring stack
docker-compose -f docker-compose.monitoring.yaml restart
```

## Maintenance Procedures

### Update Application
```bash
cd /root/lianel/dc

# Pull latest changes
git pull

# Rebuild and restart services
docker-compose -f docker-compose.frontend.yaml build
docker-compose -f docker-compose.frontend.yaml up -d

# Verify
docker ps
docker logs lianel-frontend
```

### Update Docker Images
```bash
# Pull latest images
docker-compose -f docker-compose.monitoring.yaml pull

# Recreate containers
docker-compose -f docker-compose.monitoring.yaml up -d

# Clean up old images
docker image prune -a
```

### Backup Database
```bash
# Backup Airflow database
sudo -u postgres pg_dump airflow > /backup/airflow_$(date +%d-%m-%Y).sql

# Backup Keycloak database
sudo -u postgres pg_dump keycloak > /backup/keycloak_$(date +%d-%m-%Y).sql

# Backup to remote location
scp /backup/*.sql user@backup-server:/backups/
```

### Restore Database
```bash
# Restore Airflow
sudo -u postgres psql airflow < /backup/airflow_20241201.sql

# Restore Keycloak
sudo -u postgres psql keycloak < /backup/keycloak_20241201.sql

# Restart services
docker-compose -f docker-compose.airflow.yaml restart
docker-compose -f docker-compose.oauth2-proxy.yaml restart keycloak
```

### Rotate Secrets
```bash
# Generate new secrets
python -c 'import os,base64; print(base64.urlsafe_b64encode(os.urandom(32)).decode())'

# Update .env file
nano .env

# Restart affected services
docker-compose -f docker-compose.oauth2-proxy.yaml restart
```

### Monitor Disk Usage
```bash
# Check disk usage
df -h

# Check Docker disk usage
docker system df

# Clean up
docker system prune -a --volumes
```

## Rollback Procedures

### Rollback Application
```bash
# Revert to previous commit
git log --oneline
git checkout <previous-commit>

# Rebuild and restart
docker-compose -f docker-compose.frontend.yaml build
docker-compose -f docker-compose.frontend.yaml up -d
```

### Rollback Database
```bash
# Stop services
docker-compose -f docker-compose.airflow.yaml down

# Restore from backup
sudo -u postgres psql airflow < /backup/airflow_<date>.sql

# Restart services
docker-compose -f docker-compose.airflow.yaml up -d
```

## Disaster Recovery

### Complete System Failure
1. Provision new VPS server
2. Follow "Initial Server Setup"
3. Restore configuration from Git
4. Restore databases from backup
5. Restore Docker volumes from backup
6. Follow "Application Deployment"
7. Update DNS if IP changed
8. Verify all services

### Data Loss
1. Stop affected services
2. Restore from most recent backup
3. Verify data integrity
4. Restart services
5. Monitor for issues

## Monitoring Deployment Health

```bash
# Create health check script
cat > /root/health-check.sh << 'EOF'
#!/bin/bash
echo "=== Container Status ==="
docker ps --format "table {{.Names}}\t{{.Status}}"

echo -e "\n=== Service Health ==="
curl -s -o /dev/null -w "Frontend: %{http_code}\n" https://www.lianel.se
curl -s -o /dev/null -w "Grafana: %{http_code}\n" https://www.lianel.se/monitoring/
curl -s -o /dev/null -w "Airflow: %{http_code}\n" https://airflow.lianel.se
curl -s -o /dev/null -w "Keycloak: %{http_code}\n" https://auth.lianel.se

echo -e "\n=== Resource Usage ==="
free -h | grep Mem
df -h | grep -E '/$|/var'

echo -e "\n=== Recent Errors ==="
docker logs nginx-proxy --since 1h 2>&1 | grep -i error | tail -5
EOF

chmod +x /root/health-check.sh

# Run health check
/root/health-check.sh
```

## Automated Deployment (CI/CD)

### GitHub Actions Example
```yaml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /root/lianel/dc
            git pull
            docker-compose -f docker-compose.frontend.yaml build
            docker-compose -f docker-compose.frontend.yaml up -d
```
